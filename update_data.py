s_p = {'s_p': 'https://finance.yahoo.com/quote/%5Espx/'}

technology = {'APPL': 'https://finance.yahoo.com/quote/AAPL?p=AAPL&.tsrc=fin-srch',
              'MSFT': 'https://finance.yahoo.com/quote/MSFT?p=MSFT&.tsrc=fin-srch',
              'AMZN': 'https://finance.yahoo.com/quote/AMZN?p=AMZN&.tsrc=fin-srch',
              'FB': 'https://finance.yahoo.com/quote/META?p=META&.tsrc=fin-srch',
              'GOOGL': 'https://finance.yahoo.com/quote/GOOGL?p=GOOGL&.tsrc=fin-srch',
              'INTC': 'https://finance.yahoo.com/quote/INTC?p=INTC&.tsrc=fin-srch',
              'NVDA': 'https://finance.yahoo.com/quote/NVDA?p=NVDA&.tsrc=fin-srch',
              'ADBE': 'https://finance.yahoo.com/quote/ADBE?p=ADBE&.tsrc=fin-srch',
              'TSLA': 'https://finance.yahoo.com/quote/TSLA?p=TSLA&.tsrc=fin-srch',
              'NFLX': 'https://finance.yahoo.com/quote/NFLX?p=NFLX&.tsrc=fin-srch',
              'VZ': 'https://finance.yahoo.com/quote/VZ?p=VZ&.tsrc=fin-srch',
              'T': 'https://finance.yahoo.com/quote/T?p=T&.tsrc=fin-srch',
              'CMCSA': 'https://finance.yahoo.com/quote/CMCSA?p=CMCSA&.tsrc=fin-srch'}

health = {'JNJ': 'https://finance.yahoo.com/quote/JNJ?p=JNJ&.tsrc=fin-srch',
          'PFE': 'https://finance.yahoo.com/quote/PFE?p=PFE&.tsrc=fin-srch',
          'MRK': 'https://finance.yahoo.com/quote/MRK?p=MRK&.tsrc=fin-srch',
          'ABT': 'https://finance.yahoo.com/quote/ABT?p=ABT&.tsrc=fin-srch',
          'BMY': 'https://finance.yahoo.com/quote/BMY?p=BMY&.tsrc=fin-srch',
          'UNH': 'https://finance.yahoo.com/quote/UNH?p=UNH&.tsrc=fin-srch',
          'AMGN': 'https://finance.yahoo.com/quote/AMGN?p=AMGN&.tsrc=fin-srch',
          'GILD': 'https://finance.yahoo.com/quote/GILD?p=GILD&.tsrc=fin-srch',
          'LLY': 'https://finance.yahoo.com/quote/LLY?p=LLY&.tsrc=fin-srch',
          'TMO': 'https://finance.yahoo.com/quote/TMO?p=TMO&.tsrc=fin-srch',
          'MDT': 'https://finance.yahoo.com/quote/MDT?p=MDT&.tsrc=fin-srch'}

finance = {'JPM': 'https://finance.yahoo.com/quote/GILD?p=GILD&.tsrc=fin-srch',
           'BAC': 'https://finance.yahoo.com/quote/BAC?p=BAC&.tsrc=fin-srch',
           'WFC': 'https://finance.yahoo.com/quote/WFC?p=WFC&.tsrc=fin-srch',
           'C': 'https://finance.yahoo.com/quote/C?p=C&.tsrc=fin-srch',
           'GS': 'https://finance.yahoo.com/quote/GS?p=GS&.tsrc=fin-srch',
           'MS': 'https://finance.yahoo.com/quote/MS?p=MS&.tsrc=fin-srch',
           'AXP': 'https://finance.yahoo.com/quote/AXP?p=AXP&.tsrc=fin-srch',
           'V': 'https://finance.yahoo.com/quote/V?p=V&.tsrc=fin-srch',
           'MA': 'https://finance.yahoo.com/quote/MA?p=MA&.tsrc=fin-srch',
           'COF': 'https://finance.yahoo.com/quote/COF?p=COF&.tsrc=fin-srch'}

consumer_discretionary = {'HD': 'https://finance.yahoo.com/quote/HD?p=HD&.tsrc=fin-srch',
                          'MCD': 'https://finance.yahoo.com/quote/MCD?p=MCD&.tsrc=fin-srch',
                          'NKE': 'https://finance.yahoo.com/quote/NKE?p=NKE&.tsrc=fin-srch',
                          'DIS': 'https://finance.yahoo.com/quote/DIS?p=DIS&.tsrc=fin-srch',
                          'SBUX': 'https://finance.yahoo.com/quote/SBUX?p=SBUX&.tsrc=fin-srch',
                          'TGT': 'https://finance.yahoo.com/quote/TGT?p=TGT&.tsrc=fin-srch',
                          'WMT': 'https://finance.yahoo.com/quote/WMT?p=WMT&.tsrc=fin-srch',
                          'COST': 'https://finance.yahoo.com/quote/COST?p=COST&.tsrc=fin-srch',
                          'LOW': 'https://finance.yahoo.com/quote/LOW?p=LOW&.tsrc=fin-srch',
                          'TJX': 'https://finance.yahoo.com/quote/TJX?p=TJX&.tsrc=fin-srch',
                          'CVS': 'https://finance.yahoo.com/quote/CVS?p=CVS&.tsrc=fin-srch'}

industrial = {'GE': 'https://finance.yahoo.com/quote/GE?p=GE&.tsrc=fin-srch',
              'HON': 'https://finance.yahoo.com/quote/HON?p=HON&.tsrc=fin-srch',
              'UTX': 'https://finance.yahoo.com/quote/UTX.VI?p=UTX.VI&.tsrc=fin-srch',
              'MMM': 'https://finance.yahoo.com/quote/MMM?p=MMM&.tsrc=fin-srch',
              'BA': 'https://finance.yahoo.com/quote/BA?p=BA&.tsrc=fin-srch',
              'CAT': 'https://finance.yahoo.com/quote/CAT?p=CAT&.tsrc=fin-srch',
              'UNP': 'https://finance.yahoo.com/quote/UNP?p=UNP&.tsrc=fin-srch',
              'LMT': 'https://finance.yahoo.com/quote/LMT?p=LMT&.tsrc=fin-srch',
              'ITW': 'https://finance.yahoo.com/quote/ITW?p=ITW&.tsrc=fin-srch',
              'RTX': 'https://finance.yahoo.com/quote/RTX?p=RTX&.tsrc=fin-srch'}

cosumer_staples = {'PG': 'https://finance.yahoo.com/quote/PG?p=PG&.tsrc=fin-srch',
                   'KO': 'https://finance.yahoo.com/quote/KO?p=KO&.tsrc=fin-srch',
                   'PEP': 'https://finance.yahoo.com/quote/PEP?p=PEP&.tsrc=fin-srch',
                   'WMT': 'https://finance.yahoo.com/quote/WMT?p=WMT&.tsrc=fin-srch',
                   'CL': 'https://finance.yahoo.com/quote/CL?p=CL&.tsrc=fin-srch',
                   'KHC': 'https://finance.yahoo.com/quote/KHC?p=KHC&.tsrc=fin-srch',
                   'PM': 'https://finance.yahoo.com/quote/PM?p=PM&.tsrc=fin-srch',
                   'MDLZ': 'https://finance.yahoo.com/quote/MDLZ?p=MDLZ&.tsrc=fin-srch',
                   'MO': 'https://finance.yahoo.com/quote/MO?p=MO&.tsrc=fin-srch',
                   'COST': 'https://finance.yahoo.com/quote/COST?p=COST&.tsrc=fin-srch'}

energy = {'XOM': 'https://finance.yahoo.com/quote/XOM?p=XOM&.tsrc=fin-srch',
          'CVX': 'https://finance.yahoo.com/quote/CVX?p=CVX&.tsrc=fin-srch',
          'COP': 'https://finance.yahoo.com/quote/COP?p=COP&.tsrc=fin-srch',
          'SLB': 'https://finance.yahoo.com/quote/SLB?p=SLB&.tsrc=fin-srch',
          'EOG': 'https://finance.yahoo.com/quote/EOG?p=EOG&.tsrc=fin-srch',
          'KMI': 'https://finance.yahoo.com/quote/KMI?p=KMI&.tsrc=fin-srch',
          'PSX': 'https://finance.yahoo.com/quote/PSX?p=PSX&.tsrc=fin-srch',
          'VLO': 'https://finance.yahoo.com/quote/VLO?p=VLO&.tsrc=fin-srch',
          'OXY': 'https://finance.yahoo.com/quote/OXY?p=OXY&.tsrc=fin-srch',
          'MPC': 'https://finance.yahoo.com/quote/MPC?p=MPC&.tsrc=fin-srch'}

utility = {'NEE': 'https://finance.yahoo.com/quote/NEE?p=NEE&.tsrc=fin-srch',
           'DUK': 'https://finance.yahoo.com/quote/DUK?p=DUK&.tsrc=fin-srch',
           'D': 'https://finance.yahoo.com/quote/D?p=D&.tsrc=fin-srch',
           'SO': 'https://finance.yahoo.com/quote/SO?p=SO&.tsrc=fin-srch',
           'AEP': 'https://finance.yahoo.com/quote/AEP?p=AEP&.tsrc=fin-srch',
           'EXC': 'https://finance.yahoo.com/quote/EXC?p=EXC&.tsrc=fin-srch',
           'ED': 'https://finance.yahoo.com/quote/ED?p=ED&.tsrc=fin-srch',
           'PEG': 'https://finance.yahoo.com/quote/PEG?p=PEG&.tsrc=fin-srch',
           'SRE': 'https://finance.yahoo.com/quote/SRE?p=SRE&.tsrc=fin-srch',
           'EIX': 'https://finance.yahoo.com/quote/EIX?p=EIX&.tsrc=fin-srch'}

real_estate = {'AMT': 'https://finance.yahoo.com/quote/AMT?p=AMT&.tsrc=fin-srch',
               'PLD': 'https://finance.yahoo.com/quote/PLD?p=PLD&.tsrc=fin-srch',
               'CCI': 'https://finance.yahoo.com/quote/CCI?p=CCI&.tsrc=fin-srch',
               'SPG': 'https://finance.yahoo.com/quote/SPG?p=SPG&.tsrc=fin-srch',
               'EQIX': 'https://finance.yahoo.com/quote/EQIX?p=EQIX&.tsrc=fin-srch',
               'PSA': 'https://finance.yahoo.com/quote/PSA?p=PSA&.tsrc=fin-srch',
               'AVB': 'https://finance.yahoo.com/quote/AVB?p=AVB&.tsrc=fin-srch',
               'WELL': 'https://finance.yahoo.com/quote/WELL?p=WELL&.tsrc=fin-srch',
               'BXP': 'https://finance.yahoo.com/quote/BXP?p=BXP&.tsrc=fin-srch',
               'O': 'https://finance.yahoo.com/quote/O?p=O&.tsrc=fin-srch'}

commodities = {'gold': 'https://finance.yahoo.com/quote/GC=F?p=GC=F&.tsrc=fin-srch',
               'oil': 'https://finance.yahoo.com/quote/CL=F?p=CL=F&.tsrc=fin-srch',
               'gas': 'https://finance.yahoo.com/quote/NG=F?p=NG=F&.tsrc=fin-srch',
               'copper': 'https://finance.yahoo.com/quote/HG=F?p=HG=F&.tsrc=fin-srch',
               'lithium': 'https://finance.yahoo.com/quote/ILIT?p=ILIT&.tsrc=fin-srch',
               'uranium': 'https://finance.yahoo.com/quote/URA?p=URA&.tsrc=fin-srch',
               'corn': 'https://finance.yahoo.com/quote/CORN?p=CORN&.tsrc=fin-srch',
               'wheat': 'https://finance.yahoo.com/quote/ZW=F?p=ZW=F&.tsrc=fin-srch',
               'soybeans': 'https://finance.yahoo.com/quote/SAS=F?p=SAS=F&.tsrc=fin-srch',
               'sugar': 'https://finance.yahoo.com/quote/SB=F?p=SB=F&.tsrc=fin-srch'}

import logging
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from pymongo.mongo_client import MongoClient
import certifi
from datetime import datetime
import random 
import time

logging.basicConfig(filename='error.log', level=logging.ERROR, format='%(asctime)s - %(levelname)s - %(message)s')

def scrap_data(url, driver, documents, sector_name, ticker):
    driver.get(url)
    price = driver.find_element(By.XPATH, '//*[@id="quote-header-info"]/div[3]/div[1]/div[1]/fin-streamer[1]').text
    price = price.replace(',', '')
    change = driver.find_element(By.XPATH, '//*[@id="quote-header-info"]/div[3]/div[1]/div[1]/fin-streamer[3]/span').text[1:-2] 
    documents[sector_name][ticker] = float(price)
    documents[sector_name]['change_average'].append(float(change))

def get_change_average(documents, sector_name):
    changes = documents[sector_name]['change_average']
    total_sum = sum(changes)
    total_count = len(changes)
    documents[sector_name]['change_average'] = round(total_sum/total_count, 2)

def update_database(sector_names, documents, db):
    for sector in sector_names:
        collection = db[sector]
        document = documents[sector]
        try:
            result = collection.insert_one(document)
            print(f'inserted {sector}', result.inserted_id)
        except Exception as e: 
            print(f'error with {sector}, {str(e)}')
            logging.error(f'error with {sector}, {str(e)}')

def get_s_and_p(s_p, driver, db, collection_name, date):
    driver.get(s_p)
    price = driver.find_element(By.XPATH, '//*[@id="quote-header-info"]/div[3]/div[1]/div[1]/fin-streamer[1]').text
    price = price.replace(',', '')
    change = driver.find_element(By.XPATH, '//*[@id="quote-header-info"]/div[3]/div[1]/div[1]/fin-streamer[3]/span').text[1:-2] 
    document = {'date': date, 'price': float(price), 'change': float(change)}

    collection = db[collection_name]
    try:
        result = collection.insert_one(document)
        print(f'inserted {collection_name}', result.inserted_id)
    except Exception as e:
        print(f'error with {collection_name}, {str(e)}') 
        logging.error(f'error with {collection_name}, {str(e)}')

def get_data(driver, sectors, sector_names, documents, date):
    for sector, sector_name in zip(sectors, sector_names):
        print(f'{sector_name}------------')
        for ticker in sector:
            time.sleep(random.random()*2)
            print(ticker)
            try:
                scrap_data(sector[ticker], driver, documents, sector_name, ticker)
            except Exception as e:
                logging.error(f'error with {ticker}, {str(e)}')
                documents[sector_name][f'{ticker}_price'] = 0
                documents[sector_name]['change_average'].append(0)
        get_change_average(documents, sector_name)


    uri = "mongodb+srv://jmetzg11:G3Ql9orCKrrZ1eKF@stocks.gqzzrrh.mongodb.net/?retryWrites=true&w=majority"
    client = MongoClient(uri)
    db = client['stocks']

    update_database(sector_names, documents, db)

    s_p = 'https://finance.yahoo.com/quote/AAPL?p=AAPL&.tsrc=fin-srch'
    get_s_and_p(s_p, driver, db, 's_p', date)
    
    driver.quit()
    client.close()


sectors = [technology, health, finance, consumer_discretionary, industrial, cosumer_staples,
           energy, utility, real_estate, commodities]
sector_names = ['technology', 'health', 'finance', 'consumer_discretionary', 'industrial', 'cosumer_staples',
                'energy', 'utility', 'real_estate', 'commodities']
documents = {}
current_date = datetime.now().date()
date = datetime.combine(current_date, datetime.min.time())
for sector_name in sector_names:
    documents[sector_name] = {}
    documents[sector_name]['date'] = date
    documents[sector_name]['change_average'] = []

chrome_options = Options()
chrome_options.add_argument('--headless')
driver = webdriver.Chrome(options=chrome_options)


get_data(driver, sectors, sector_names, documents, date)


